name: Deploy to Nomad (Podman)

on:
  push:
    branches: [ "main", "master" ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  NOMAD_TOKEN: ${{ secrets.NOMAD_TOKEN }}  # Si nécessaire
  NOMAD_REGION: "us-east-1"               # Si nécessaire
  NOMAD_NAMESPACE: "default"             # Si nécessaire

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Image Name
        run: echo "FULL_IMAGE_NAME=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_ENV

      - name: Log in to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | podman login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Build image with Podman
        run: podman build -t ${{ env.FULL_IMAGE_NAME }} .

      - name: Push image with Podman
        run: podman push ${{ env.FULL_IMAGE_NAME }}

      - name: Install Nomad CLI
        run: |
          curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
          sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
          sudo apt-get update && sudo apt-get install -y nomad=1.7.2-1

      - name: Deploy to Nomad
        run: |
          export NOMAD_ADDR=${{ secrets.NOMAD_ADDR }}
          export NOMAD_TOKEN=${{ secrets.NOMAD_TOKEN }}  # Si nécessaire
          nomad job run \
            -var="image=${{ env.FULL_IMAGE_NAME }}" \
            eldocam.nomad.hcl
